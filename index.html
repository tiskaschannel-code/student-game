<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Adventure Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Mitr', sans-serif; background: #FFF9E3; }
        .game-card { border: 4px solid #FFB6C1; border-radius: 2rem; box-shadow: 0 8px 0 #FFB6C1; }
        .btn-cute { transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .btn-cute:active { transform: translateY(4px); box-shadow: none; }
        #reader { width: 100%; border-radius: 1rem; overflow: hidden; border: none !important; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="loginPage" class="w-full max-w-sm bg-white p-8 game-card text-center">
        <h1 class="text-3xl font-bold text-pink-500 mb-6">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! üéÆ</h1>
        <p class="mb-4 text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å</p>
        <input type="text" id="studentId" maxlength="5" placeholder="xxxxx" 
               class="w-full text-center text-2xl p-3 border-2 border-yellow-300 rounded-full mb-6 focus:outline-none focus:border-pink-400">
        <button onclick="login()" class="w-full bg-pink-400 text-white py-3 rounded-full text-xl font-bold btn-cute">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°</button>
    </div>

    <div id="mainPage" class="hidden w-full max-w-sm bg-white p-6 game-card relative">
        <button onclick="toggleSettings()" class="absolute top-4 right-4 bg-yellow-200 p-2 rounded-full hover:bg-yellow-300">‚öôÔ∏è</button>

        <div class="text-center mt-6">
            <img id="displayImg" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Buddy" class="w-28 h-28 mx-auto rounded-full border-4 border-pink-200 bg-blue-50">
            <h2 id="displayName" class="text-2xl font-bold text-gray-800 mt-2">‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <div class="inline-block bg-pink-100 px-4 py-1 rounded-full text-pink-600 font-bold mt-1">
                ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="currentScore">0</span> üíé
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4 mt-8">
            <button onclick="openScanner()" class="flex items-center p-4 bg-green-100 border-2 border-green-200 rounded-2xl btn-cute text-left">
                <span class="text-4xl mr-4">üì∏</span>
                <div><p class="font-bold text-green-700">‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</p><p class="text-xs text-green-600">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</p></div>
            </button>
            <a href="https://www.google.com" target="_blank" class="flex items-center p-4 bg-purple-100 border-2 border-purple-200 rounded-2xl btn-cute text-left">
                <span class="text-4xl mr-4">üè´</span>
                <div><p class="font-bold text-purple-700">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π</p><p class="text-xs text-purple-600">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p></div>
            </a>
        </div>

        <div class="mt-8 bg-yellow-50 rounded-2xl p-4 border-2 border-yellow-200">
            <h3 class="text-center font-bold text-yellow-700 mb-4 text-sm">üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤‡πÅ‡∏ï‡πâ‡∏° (Top 10)</h3>
            <div id="leaderboardList" class="space-y-2 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <button onclick="updateLeaderboard()" class="w-full mt-4 text-[10px] text-yellow-600 underline">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</button>
        </div>

        <div class="mt-8 bg-pink-50 rounded-2xl p-4 border-2 border-pink-200">
            <h3 class="text-center font-bold text-pink-700 mb-4 text-sm">üéÅ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
            <div class="grid grid-cols-2 gap-3">
                <div onclick="redeem('‡∏Ç‡∏ô‡∏°', 50)" class="bg-white p-2 rounded-xl text-center border cursor-pointer hover:bg-pink-100 transition">
                    <span class="text-2xl">üçø</span><p class="text-xs font-bold mt-1">‡∏Ç‡∏ô‡∏°</p><p class="text-[10px] text-pink-500">50 ‡πÅ‡∏ï‡πâ‡∏°</p>
                </div>
                <div onclick="redeem('‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå', 20)" class="bg-white p-2 rounded-xl text-center border cursor-pointer hover:bg-pink-100 transition">
                    <span class="text-2xl">‚≠ê</span><p class="text-xs font-bold mt-1">‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</p><p class="text-[10px] text-pink-500">20 ‡πÅ‡∏ï‡πâ‡∏°</p>
                </div>
            </div>
        </div>
    </div>

    <div id="scannerModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-4 rounded-3xl w-full max-w-sm">
            <div id="reader"></div>
            <button onclick="closeScanner()" class="w-full mt-4 bg-red-400 text-white py-2 rounded-xl">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-3xl w-full max-w-xs text-center">
            <h3 class="text-xl font-bold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
            <input type="text" id="newName" class="w-full p-2 border rounded-lg mb-4 text-center">
            <button onclick="randomAvatar()" class="w-full bg-gray-100 p-2 rounded-lg mb-6 text-sm">üîÑ ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</button>
            <div class="flex gap-2">
                <button onclick="saveSettings()" class="flex-1 bg-pink-400 text-white py-2 rounded-xl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button onclick="toggleSettings()" class="flex-1 bg-gray-200 py-2 rounded-xl">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        const scriptUrl = "https://script.google.com/macros/s/AKfycbyD0Kv74EJs5TyRn_6eFm6qbBeuux_lhnhyZom-Ae727pRu8EqDF19w00l93fLi_782_A/exec";
        const teacherSecret = "ccc";
        let score = 0;
        let html5QrCode;

        function login() {
            const id = document.getElementById('studentId').value;
            if(id.length === 5) {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainPage').classList.remove('hidden');
                updateLeaderboard();
            } else { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å"); }
        }

        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); }
        function saveSettings() { document.getElementById('displayName').innerText = document.getElementById('newName').value; toggleSettings(); }
        function randomAvatar() { document.getElementById('displayImg').src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${Math.random()}`; }

        function openScanner() {
            document.getElementById('scannerModal').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        }

        async function onScanSuccess(decodedText) {
            const dataParts = decodedText.split("_");
            if (dataParts[0] === teacherSecret) {
                const pointsToAdd = parseInt(dataParts[1]);
                await sendToSheet(pointsToAdd, "‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å QR");
                score += pointsToAdd;
                document.getElementById('currentScore').innerText = score;
                alert(`‡πÄ‡∏¢‡πâ! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${pointsToAdd} ‡πÅ‡∏ï‡πâ‡∏°`);
                updateLeaderboard();
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); }
            closeScanner();
        }

        function closeScanner() { if(html5QrCode){ html5QrCode.stop(); } document.getElementById('scannerModal').classList.add('hidden'); }

        async function redeem(item, cost) {
            if(score < cost) return alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠");
            if(confirm(`‡πÅ‡∏•‡∏Å ${item} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                await sendToSheet(-cost, `‡πÅ‡∏•‡∏Å: ${item}`);
                score -= cost;
                document.getElementById('currentScore').innerText = score;
                alert("‡πÅ‡∏•‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                updateLeaderboard();
            }
        }

        async function sendToSheet(pts, remark) {
            try {
                await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        studentId: document.getElementById('studentId').value,
                        name: document.getElementById('displayName').innerText,
                        points: pts,
                        item: remark
                    })
                });
            } catch (e) { console.log(e); }
        }

        async function updateLeaderboard() {
            try {
                const res = await fetch(scriptUrl);
                const data = await res.json();
                let html = data.map((item, i) => `
                    <div class="flex justify-between bg-white p-2 rounded-lg shadow-sm">
                        <span>${i+1}. ${item.name}</span>
                        <span class="font-bold text-pink-500">${item.score}</span>
                    </div>`).join('');
                document.getElementById('leaderboardList').innerHTML = html || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            } catch (e) { document.getElementById('leaderboardList').innerHTML = "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
        }
    </script>
</body>
</html>

